name: Issue Response Bot (Codex with gh)

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  respond-to-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install OpenAI Codex
        run: |
          npm install -g @openai/codex  # 正しいパッケージ名に修正
        
      - name: Analyze and Plan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Codexに計画を立てさせ、issueにコメントさせる
          codex -a auto-edit "以下のissueに対する対応計画を立て、ghコマンドでコメントしてください：
          
          Issue番号: #${{ github.event.issue.number }}
          タイトル: ${{ github.event.issue.title }}
          内容: ${{ github.event.issue.body }}
          
          実行してください：
          1. issueを分析して対応方針を決定
          2. ghコマンドで計画をissueにコメント (例: gh issue comment #番号 --body '内容')
          3. 必要なコード修正やドキュメント更新を実施"
      
      - name: Commit changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add .
          git commit -m "Auto: Issue #${{ github.event.issue.number }} の対応" || echo "No changes to commit"
          
          重要: 実際のGitHub操作（コメント投稿やPR作成）は別のステップで行うため、
          この段階では修正内容の準備のみを行ってください。"
      
      - name: Post comment to issue
        uses: actions/github-script@v7
        with:
          script: |
            // Codexが生成した返信を探して投稿
            // 実際の実装はCodexの出力形式に合わせて調整が必要
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '自動応答: このissueを確認しました。対応を検討中です。'
            })
      
      - name: Create PR if needed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status -s) ]]; then
            git checkout -b fix-issue-${{ github.event.issue.number }}
            git add .
            git commit -m "Auto: Codexによるissue対応 #${{ github.event.issue.number }}"
            git push origin fix-issue-${{ github.event.issue.number }}
            
            # GitHub CLIを使ってPRを作成
            gh pr create --title "Fix issue #${{ github.event.issue.number }}" \
                        --body "Fixes #${{ github.event.issue.number }}" \
                        --base main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
