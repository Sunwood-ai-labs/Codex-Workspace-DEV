name: Document Quality Check (Codex)

on:
  push:
    paths:
      - '**.md'
  pull_request:
    paths:
      - '**.md'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install OpenAI Codex
        run: |
          npm install -g @openai/codex
        
      - name: Check documentation quality with Codex
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
        run: |
          # Codexを使ってドキュメントの品質をチェック
          codex -a auto-edit  --quiet  "$(cat << 'EOF'
          リポジトリのドキュメントを品質チェックしてください。
          
          以下のチェックリストに従って確認し、必要に応じて修正してください：
          
          1. README.mdの確認
             - タイトルは中央揃えか
             - ヘッダー画像は中央揃えか
             - 技術スタックのバッジは適切に配置され、中央揃えになっているか
             - 絵文字を活用して可読性が向上しているか
             - インストール手順が明確か
             - 使用方法が明確か
          
          2. ドキュメントの階層構造
             - 各階層に適切なREADME.mdがあるか
             - 重複がないか
             - 適切にリンクが設定されているか
          
          3. 環境変数
             - .env.exampleファイルが存在するか
             - 必要な環境変数がすべて記載されているか
          
          問題がある場合は自動的に修正し、新しいブランチを作成してプルリクエストを作成してください。
          
          重要: GitHubのトークンは環境変数 GITHUB_TOKEN で利用可能です。
          EOF
          )"
      
      - name: Commit and push changes (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status -s) ]]; then
            BRANCH_NAME="docs/quality-improvement-$(date +%Y%m%d-%H%M%S)"
            git checkout -b $BRANCH_NAME
            git add .
            git commit -m "docs: ドキュメント品質の自動改善"
            git push origin $BRANCH_NAME
            
            # プルリクエストのコメントを作成
            gh pr create --title "docs: ドキュメント品質の自動改善" \
                         --body "Codexによるドキュメント品質チェックを実行し、いくつかの改善を行いました。" \
                         --base main \
                         --head $BRANCH_NAME
          fi
