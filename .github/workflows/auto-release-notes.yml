name: Auto Release Notes with Codex

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release-notes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex
        
      - name: Generate Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
          CODEX_NO_TTY: "1"
        run: |
          # ç¾åœ¨ã®ã‚¿ã‚°ã¨å‰ã®ã‚¿ã‚°ã‚’å–å¾—
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          # Codexã«ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã®ç”Ÿæˆã®ã¿ã‚’æŒ‡ç¤º
          codex -a auto-edit --quiet "ä»¥ä¸‹ã®æƒ…å ±ã‚’ä½¿ã£ã¦ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆã—ã€release_notes.mdãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼š
          
          ç¾åœ¨ã®ã‚¿ã‚°: ${CURRENT_TAG}
          å‰å›žã®ã‚¿ã‚°: ${PREVIOUS_TAG}
          
          å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          1. gitã‚³ãƒžãƒ³ãƒ‰ã§2ã¤ã®ã‚¿ã‚°é–“ã®å·®åˆ†ã‚’å–å¾—
          2. ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã¨ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’åˆ†æžã—ã¦ã€ä»¥ä¸‹ã‚’å«ã‚€ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆï¼š
             - æ–°æ©Ÿèƒ½
             - ãƒã‚°ä¿®æ­£
             - ç ´å£Šçš„å¤‰æ›´
             - ãã®ä»–ã®æ”¹å–„
          3. ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’release_notes.mdãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          
          ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã¯ä»¥ä¸‹ã®å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã—ã¦ãã ã•ã„ï¼š
          # Release ${CURRENT_TAG}
          
          ## ðŸš€ æ–°æ©Ÿèƒ½
          - æ©Ÿèƒ½ã®èª¬æ˜Ž
          
          ## ðŸ› ãƒã‚°ä¿®æ­£
          - ä¿®æ­£å†…å®¹ã®èª¬æ˜Ž
          
          ## âš ï¸ ç ´å£Šçš„å¤‰æ›´
          - å¤‰æ›´å†…å®¹ã®èª¬æ˜Ž
          
          ## ðŸ“ ãã®ä»–ã®æ”¹å–„
          - æ”¹å–„å†…å®¹ã®èª¬æ˜Ž
          
          å‰å›žã®ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€åˆå›žãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          
          ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
          echo '# Release ${CURRENT_TAG}' > release_notes.md
          echo '' >> release_notes.md
          # ... (ä»–ã®å†…å®¹) ...
          "
      
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          # release_notes.mdãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
          if [ -f release_notes.md ]; then
            gh release create ${CURRENT_TAG} --title "Release ${CURRENT_TAG}" --notes-file release_notes.md
          else
            # CodexãŒå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
            if [ -n "$PREVIOUS_TAG" ]; then
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s" > fallback_notes.md
            else
              echo "åˆå›žãƒªãƒªãƒ¼ã‚¹" > fallback_notes.md
            fi
            gh release create ${CURRENT_TAG} --title "Release ${CURRENT_TAG}" --notes-file fallback_notes.md
          fi
