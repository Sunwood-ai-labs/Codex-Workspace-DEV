name: Auto Release Notes with Codex

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release-notes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex
        
      - name: Generate Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"
          CODEX_NO_TTY: "1"
        run: |
          # 現在のタグと前のタグを取得
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          # Codexにリリースノートの生成のみを指示
          codex -a auto-edit --quiet "以下の情報を使ってリリースノートを作成し、release_notes.mdファイルに保存してください：
          
          現在のタグ: ${CURRENT_TAG}
          前回のタグ: ${PREVIOUS_TAG}
          
          実行してください：
          1. gitコマンドで2つのタグ間の差分を取得
          2. コミットログとファイル変更を分析して、以下を含むリリースノートを作成：
             - 新機能
             - バグ修正
             - 破壊的変更
             - その他の改善
          3. リリースノートをrelease_notes.mdファイルに保存
          
          リリースノートは以下の形式でフォーマットしてください：
          # Release ${CURRENT_TAG}
          
          ## 🚀 新機能
          - 機能の説明
          
          ## 🐛 バグ修正
          - 修正内容の説明
          
          ## ⚠️ 破壊的変更
          - 変更内容の説明
          
          ## 📝 その他の改善
          - 改善内容の説明
          
          前回のタグが存在しない場合は、初回リリースとして適切なメッセージを作成してください。
          
          ファイルの作成は以下のように実行してください：
          echo '# Release ${CURRENT_TAG}' > release_notes.md
          echo '' >> release_notes.md
          # ... (他の内容) ...
          "
      
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          # release_notes.mdが存在する場合はそれを使用
          if [ -f release_notes.md ]; then
            gh release create ${CURRENT_TAG} --title "Release ${CURRENT_TAG}" --notes-file release_notes.md
          else
            # Codexが失敗した場合のフォールバック
            PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
            if [ -n "$PREVIOUS_TAG" ]; then
              git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s" > fallback_notes.md
            else
              echo "初回リリース" > fallback_notes.md
            fi
            gh release create ${CURRENT_TAG} --title "Release ${CURRENT_TAG}" --notes-file fallback_notes.md
          fi
