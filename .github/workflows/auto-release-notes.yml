name: Auto Release Notes with Codex

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v2.1.3 などのタグがプッシュされた時に実行

permissions:
  contents: write

jobs:
  create-release-notes:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得して差分を比較できるようにする
      
      - name: Install OpenAI Codex
        run: npm install -g @openai/codex
        
      - name: Generate and Post Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CODEX_QUIET_MODE: "1"  # 追加: quietモードを有効化
          CODEX_NO_TTY: "1"      # 追加: TTYを無効化
        run: |
          # 現在のタグと前のタグを取得
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          # Codexにリリースノートを作成させ、ghコマンドでリリースを作成させる
          codex -a auto-edit  --quiet "以下の情報を使ってリリースノートを作成し、ghコマンドでGitHubリリースを作成してください：
          
          現在のタグ: ${CURRENT_TAG}
          前回のタグ: ${PREVIOUS_TAG}
          
          実行してください：
          1. gitコマンドで2つのタグ間の差分を取得
          2. コミットログとファイル変更を分析して、以下を含むリリースノートを作成：
             - 新機能
             - バグ修正
             - 破壊的変更
             - その他の改善
          3. ghコマンドでリリースを作成：
             gh release create ${CURRENT_TAG} --title 'Release ${CURRENT_TAG}' --notes '作成したリリースノート'
          
          リリースノートは以下の形式でフォーマットしてください：
          # Release ${CURRENT_TAG}
          
          ## 🚀 新機能
          - 機能の説明
          
          ## 🐛 バグ修正
          - 修正内容の説明
          
          ## ⚠️ 破壊的変更
          - 変更内容の説明
          
          ## 📝 その他の改善
          - 改善内容の説明
          
          前回のタグが存在しない場合は、初回リリースとして適切なメッセージを作成してください。"
